<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search - TravelSearch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .react-datepicker {
      font-family: inherit;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      display: inline-block;
      background: white;
      padding: 1rem;
    }
    .react-datepicker__month-container {
      display: block;
    }
    .react-datepicker__header {
      text-align: center;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 0.5rem;
    }
    .react-datepicker__current-month {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    .rdp-weekday-names {
      display: grid;
      grid-template-columns: repeat(7, 2.5rem);
      gap: 2px;
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }
    .react-datepicker__month {
      display: grid;
      grid-template-columns: repeat(7, 2.5rem);
      gap: 2px;
    }
    .react-datepicker__day {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .react-datepicker__day:hover {
      background-color: #dbeafe;
    }
    .react-datepicker__day--selected {
      background-color: #2563eb !important;
      color: white !important;
    }
    .react-datepicker__day--in-range {
      background-color: #bfdbfe;
    }
    .react-datepicker__day--outside-month {
      color: #d1d5db;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="text-xl font-bold text-blue-600">TravelSearch</a>
      <nav id="auth-nav" class="flex items-center space-x-4">
        <a href="/" class="text-gray-700 hover:text-blue-600">Home</a>
        <a href="/search" class="text-gray-700 hover:text-blue-600">Search</a>
        <a href="/login" class="text-gray-700 hover:text-blue-600" id="login-link">Login</a>
        <a href="/login" class="text-gray-700 hover:text-blue-600" id="register-link">Register</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-12">
    <!-- Step indicators -->
    <div class="flex items-center justify-center mb-8 space-x-4">
      <div class="step-indicator flex items-center" id="step-ind-1">
        <span class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold">1</span>
        <span class="ml-2 text-sm font-medium text-gray-700">Destination</span>
      </div>
      <div class="w-8 border-t border-gray-300"></div>
      <div class="step-indicator flex items-center" id="step-ind-2">
        <span class="w-8 h-8 rounded-full bg-gray-300 text-white flex items-center justify-center text-sm font-semibold">2</span>
        <span class="ml-2 text-sm font-medium text-gray-400">Dates</span>
      </div>
      <div class="w-8 border-t border-gray-300"></div>
      <div class="step-indicator flex items-center" id="step-ind-3">
        <span class="w-8 h-8 rounded-full bg-gray-300 text-white flex items-center justify-center text-sm font-semibold">3</span>
        <span class="ml-2 text-sm font-medium text-gray-400">Filters</span>
      </div>
      <div class="w-8 border-t border-gray-300"></div>
      <div class="step-indicator flex items-center" id="step-ind-4">
        <span class="w-8 h-8 rounded-full bg-gray-300 text-white flex items-center justify-center text-sm font-semibold">4</span>
        <span class="ml-2 text-sm font-medium text-gray-400">Results</span>
      </div>
    </div>

    <!-- Step 1: Destination -->
    <div id="step-1" class="bg-white rounded-lg shadow-md p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Where are you going?</h2>
      <div class="relative">
        <label for="destination" class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
        <input type="text" id="destination" autocomplete="off"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Search for a destination...">
        <div id="autocomplete-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden"></div>
      </div>
      <div class="mt-6">
        <button id="btn-to-step2" disabled
          class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
          Next: Select Dates
        </button>
      </div>
    </div>

    <!-- Step 2: Dates -->
    <div id="step-2" class="bg-white rounded-lg shadow-md p-8 hidden" style="display:none">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Select your dates</h2>
      <p class="text-sm text-gray-600 mb-4">Click to select check-in and check-out dates.</p>
      <div id="datepicker-container" class="react-datepicker"></div>
      <p class="mt-3 text-sm text-gray-600" id="date-selection-info">Select check-in date</p>
      <div class="mt-6">
        <button id="btn-to-step3" disabled
          class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
          Next: Refine Search
        </button>
      </div>
    </div>

    <!-- Step 3: Filters -->
    <div id="step-3" class="bg-white rounded-lg shadow-md p-8 hidden" style="display:none">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Refine your search</h2>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Price Range (per night)</h3>
        <div class="flex items-center space-x-4">
          <label class="block text-sm text-gray-600 mb-1">Min ($)</label>
          <input type="number" id="price-min" value="0" min="0"
            class="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span class="text-gray-500">to</span>
          <label class="block text-sm text-gray-600 mb-1">Max ($)</label>
          <input type="number" id="price-max" value="1000" min="0"
            class="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Amenities</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Wi-Fi" value="Wi-Fi" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Wi-Fi</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Pool" value="Pool" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Pool</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Gym" value="Gym" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Gym</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Spa" value="Spa" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Spa</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Parking" value="Parking" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Parking</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Restaurant" value="Restaurant" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Restaurant</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Room-service" value="Room service" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Room service</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="amenity-Breakfast" value="Breakfast" class="amenity-checkbox rounded text-blue-600">
            <span class="text-sm text-gray-700">Breakfast</span>
          </label>
        </div>
      </div>
      <button id="btn-search"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 font-semibold">
        Search
      </button>
    </div>

    <!-- Step 4: Results -->
    <div id="step-4" class="hidden" style="display:none">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Search Results</h2>
      <div id="results-container" class="space-y-6"></div>
      <div id="save-search-container" class="mt-8 hidden">
        <button id="btn-save-search"
          class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 font-semibold">
          Save this Search
        </button>
        <div id="save-success" class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-md mt-4 hidden">
          Search saved successfully! View it on your <a href="/dashboard" class="underline font-semibold">Dashboard</a>.
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- State ---
    let isAuthenticated = false;
    let selectedDestination = '';
    let checkInDate = null;
    let checkOutDate = null;
    const DESTINATIONS = [
      "Paris, France", "Tokyo, Japan", "New York, USA", "London, UK", "Rome, Italy",
      "Sydney, Australia", "Barcelona, Spain", "Dubai, UAE", "Bangkok, Thailand", "Cape Town, South Africa"
    ];

    // --- Auth check ---
    (async () => {
      try {
        const res = await fetch('/api/auth/status');
        const data = await res.json();
        isAuthenticated = data.authenticated;
        const nav = document.getElementById('auth-nav');
        if (data.authenticated) {
          document.getElementById('login-link').remove();
          document.getElementById('register-link').remove();
          const dashLink = document.createElement('a');
          dashLink.href = '/dashboard';
          dashLink.className = 'text-gray-700 hover:text-blue-600';
          dashLink.textContent = 'Dashboard';
          const logoutBtn = document.createElement('button');
          logoutBtn.className = 'text-gray-700 hover:text-blue-600';
          logoutBtn.textContent = 'Logout';
          logoutBtn.onclick = async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
          };
          nav.appendChild(dashLink);
          nav.appendChild(logoutBtn);
        }
      } catch (e) {}
    })();

    // --- Step 1: Destination autocomplete ---
    const destinationInput = document.getElementById('destination');
    const dropdown = document.getElementById('autocomplete-dropdown');
    const btnToStep2 = document.getElementById('btn-to-step2');

    destinationInput.addEventListener('input', () => {
      const val = destinationInput.value.trim().toLowerCase();
      dropdown.innerHTML = '';
      if (val.length === 0) {
        dropdown.classList.add('hidden');
        btnToStep2.disabled = true;
        selectedDestination = '';
        return;
      }
      const matches = DESTINATIONS.filter(d => d.toLowerCase().includes(val));
      if (matches.length === 0) {
        dropdown.classList.add('hidden');
        return;
      }
      matches.forEach(m => {
        const div = document.createElement('div');
        div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm text-gray-700';
        div.textContent = m;
        div.addEventListener('click', () => {
          destinationInput.value = m;
          selectedDestination = m;
          dropdown.classList.add('hidden');
          btnToStep2.disabled = false;
        });
        dropdown.appendChild(div);
      });
      dropdown.classList.remove('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && e.target !== destinationInput) {
        dropdown.classList.add('hidden');
      }
    });

    // --- Step navigation ---
    // Store detached step elements
    const detachedSteps = {};
    const stepParent = document.querySelector('main');
    const stepAnchors = {};
    for (let i = 1; i <= 4; i++) {
      const el = document.getElementById('step-' + i);
      if (el) {
        stepAnchors[i] = document.createComment('step-' + i);
        el.parentNode.insertBefore(stepAnchors[i], el);
      }
    }

    function showStep(n) {
      for (let i = 1; i <= 4; i++) {
        if (i === n) {
          // Reattach if detached
          if (detachedSteps[i]) {
            stepAnchors[i].parentNode.insertBefore(detachedSteps[i], stepAnchors[i].nextSibling);
            delete detachedSteps[i];
          }
          const el = document.getElementById('step-' + i);
          if (el) {
            el.style.display = '';
            el.classList.remove('hidden');
          }
        } else {
          const el = document.getElementById('step-' + i);
          if (el && el.parentNode) {
            // Detach from DOM entirely
            detachedSteps[i] = el;
            el.parentNode.removeChild(el);
          }
        }

        const ind = document.getElementById('step-ind-' + i);
        if (ind) {
          const circle = ind.querySelector('span');
          const label = ind.querySelectorAll('span')[1];
          if (i <= n) {
            circle.className = 'w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold';
            label.className = 'ml-2 text-sm font-medium text-gray-700';
          } else {
            circle.className = 'w-8 h-8 rounded-full bg-gray-300 text-white flex items-center justify-center text-sm font-semibold';
            label.className = 'ml-2 text-sm font-medium text-gray-400';
          }
        }
      }
    }

    btnToStep2.addEventListener('click', () => {
      if (!selectedDestination) return;
      showStep(2);
      renderCalendar();
    });

    document.getElementById('btn-to-step3').addEventListener('click', () => {
      showStep(3);
    });

    document.getElementById('btn-search').addEventListener('click', () => {
      performSearch();
    });

    // --- Step 2: Date picker ---
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function renderCalendar() {
      const container = document.getElementById('datepicker-container');
      container.innerHTML = '';

      const monthContainer = document.createElement('div');
      monthContainer.className = 'react-datepicker__month-container';

      const header = document.createElement('div');
      header.className = 'react-datepicker__header';

      const navRow = document.createElement('div');
      navRow.className = 'flex items-center justify-between mb-2';

      const prevBtn = document.createElement('button');
      prevBtn.textContent = '‹';
      prevBtn.className = 'text-gray-600 hover:text-gray-900 text-xl px-2';
      prevBtn.onclick = () => {
        currentMonth--;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar();
      };

      const nextBtn = document.createElement('button');
      nextBtn.textContent = '›';
      nextBtn.className = 'text-gray-600 hover:text-gray-900 text-xl px-2';
      nextBtn.onclick = () => {
        currentMonth++;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar();
      };

      const monthLabel = document.createElement('div');
      monthLabel.className = 'react-datepicker__current-month';
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      monthLabel.textContent = monthNames[currentMonth] + ' ' + currentYear;

      navRow.appendChild(prevBtn);
      navRow.appendChild(monthLabel);
      navRow.appendChild(nextBtn);
      header.appendChild(navRow);

      const dayNamesRow = document.createElement('div');
      dayNamesRow.className = 'rdp-weekday-names';
      ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d => {
        const span = document.createElement('div');
        span.textContent = d;
        dayNamesRow.appendChild(span);
      });
      header.appendChild(dayNamesRow);

      const month = document.createElement('div');
      month.className = 'react-datepicker__month';

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

      // Previous month's trailing days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = document.createElement('div');
        day.className = 'react-datepicker__day react-datepicker__day--outside-month';
        day.textContent = String(daysInPrevMonth - i);
        month.appendChild(day);
      }

      // Current month days
      for (let d = 1; d <= daysInMonth; d++) {
        const day = document.createElement('div');
        day.className = 'react-datepicker__day';
        day.textContent = String(d);

        const dateObj = new Date(currentYear, currentMonth, d);
        if (checkInDate && dateObj.getTime() === checkInDate.getTime()) {
          day.classList.add('react-datepicker__day--selected');
        }
        if (checkOutDate && dateObj.getTime() === checkOutDate.getTime()) {
          day.classList.add('react-datepicker__day--selected');
        }
        if (checkInDate && checkOutDate && dateObj > checkInDate && dateObj < checkOutDate) {
          day.classList.add('react-datepicker__day--in-range');
        }

        day.addEventListener('click', () => {
          if (!checkInDate || (checkInDate && checkOutDate)) {
            checkInDate = dateObj;
            checkOutDate = null;
            document.getElementById('date-selection-info').textContent = 'Check-in: ' + formatDate(checkInDate) + ' — Select check-out date';
            document.getElementById('btn-to-step3').disabled = true;
          } else {
            if (dateObj <= checkInDate) {
              checkInDate = dateObj;
              document.getElementById('date-selection-info').textContent = 'Check-in: ' + formatDate(checkInDate) + ' — Select check-out date';
            } else {
              checkOutDate = dateObj;
              document.getElementById('date-selection-info').textContent = 'Check-in: ' + formatDate(checkInDate) + ' — Check-out: ' + formatDate(checkOutDate);
              document.getElementById('btn-to-step3').disabled = false;
            }
          }
          updateCalendarSelection();
        });

        month.appendChild(day);
      }

      // Next month's leading days
      const totalCells = firstDay + daysInMonth;
      const remaining = (7 - (totalCells % 7)) % 7;
      for (let i = 1; i <= remaining; i++) {
        const day = document.createElement('div');
        day.className = 'react-datepicker__day react-datepicker__day--outside-month';
        day.textContent = String(i);
        month.appendChild(day);
      }

      monthContainer.appendChild(header);
      monthContainer.appendChild(month);
      container.appendChild(monthContainer);
    }

    function updateCalendarSelection() {
      const days = document.querySelectorAll('.react-datepicker__day:not(.react-datepicker__day--outside-month)');
      days.forEach(dayEl => {
        const dayNum = parseInt(dayEl.textContent);
        const dateObj = new Date(currentYear, currentMonth, dayNum);
        dayEl.classList.remove('react-datepicker__day--selected', 'react-datepicker__day--in-range');
        if (checkInDate && dateObj.getTime() === checkInDate.getTime()) {
          dayEl.classList.add('react-datepicker__day--selected');
        }
        if (checkOutDate && dateObj.getTime() === checkOutDate.getTime()) {
          dayEl.classList.add('react-datepicker__day--selected');
        }
        if (checkInDate && checkOutDate && dateObj > checkInDate && dateObj < checkOutDate) {
          dayEl.classList.add('react-datepicker__day--in-range');
        }
      });
    }

    function formatDate(d) {
      if (!d) return '';
      return (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear();
    }

    // --- Step 4: Search ---
    function generateListings(destination) {
      const dest = destination.split(',')[0] + ',';
      return [
        {
          title: destination + ' Luxury Hotel',
          destination: dest,
          price: 350,
          description: 'Experience luxury and comfort in this amazing hotel with stunning views.',
          amenities: ['Wi-Fi', 'Pool', 'Spa', 'Room service'],
          isPremium: true
        },
        {
          title: destination + ' Budget Stay',
          destination: dest,
          price: 120,
          description: 'Affordable accommodation in a convenient location.',
          amenities: ['Wi-Fi', 'Breakfast'],
          isPremium: false
        },
        {
          title: destination + ' Family Resort',
          destination: dest,
          price: 250,
          description: 'Perfect for families with children, featuring kids club and activities.',
          amenities: ['Wi-Fi', 'Pool', 'Parking', 'Restaurant'],
          isPremium: false
        }
      ];
    }

    // Store last search params for save
    let lastSearchParams = {};

    function performSearch() {
      const minPrice = parseInt(document.getElementById('price-min').value) || 0;
      const maxPrice = parseInt(document.getElementById('price-max').value) || 1000;
      const selectedAmenities = [];
      document.querySelectorAll('.amenity-checkbox:checked').forEach(cb => {
        selectedAmenities.push(cb.value);
      });
      lastSearchParams = { minPrice, maxPrice, amenities: selectedAmenities };

      let listings = generateListings(selectedDestination);

      // Filter by price
      listings = listings.filter(l => l.price >= minPrice && l.price <= maxPrice);

      // Filter by amenities
      if (selectedAmenities.length > 0) {
        listings = listings.filter(l =>
          selectedAmenities.every(a => l.amenities.includes(a))
        );
      }

      // If not authenticated, hide premium
      if (!isAuthenticated) {
        listings = listings.filter(l => !l.isPremium);
      }

      showStep(4);
      renderResults(listings, minPrice, maxPrice, selectedAmenities);
    }

    function renderResults(listings, minPrice, maxPrice, amenities) {
      const container = document.getElementById('results-container');
      container.innerHTML = '';

      if (listings.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No results found matching your criteria.</p>';
        return;
      }

      listings.forEach(listing => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-md overflow-hidden';

        let premiumBadge = '';
        if (listing.isPremium) {
          premiumBadge = '<div class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded">Premium</div>';
        }

        const amenityHTML = listing.amenities.map(a =>
          `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded">${a}</span>`
        ).join('');

        card.innerHTML = `
          <div class="p-6">
            <div class="flex items-start justify-between mb-2">
              <h3 class="text-lg font-semibold text-gray-900">${listing.title}</h3>
              ${premiumBadge}
            </div>
            <p class="text-blue-600 text-xl font-bold mb-2">$${listing.price}/night</p>
            <p class="text-gray-600 mb-4">${listing.description}</p>
            <div class="flex flex-wrap gap-2">
              ${amenityHTML}
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      // Show save button if authenticated
      const saveContainer = document.getElementById('save-search-container');
      if (isAuthenticated) {
        saveContainer.classList.remove('hidden');
        document.getElementById('save-success').classList.add('hidden');
      }
    }

    // --- Save search ---
    document.getElementById('btn-save-search').addEventListener('click', async () => {
      try {
        const res = await fetch('/api/user/searches', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            destination: selectedDestination,
            checkIn: checkInDate ? formatDate(checkInDate) : '',
            checkOut: checkOutDate ? formatDate(checkOutDate) : '',
            minPrice: lastSearchParams.minPrice || 0,
            maxPrice: lastSearchParams.maxPrice || 1000,
            amenities: lastSearchParams.amenities || []
          })
        });
        if (res.ok) {
          document.getElementById('save-success').classList.remove('hidden');
          document.getElementById('btn-save-search').disabled = true;
          document.getElementById('btn-save-search').classList.add('opacity-50', 'cursor-not-allowed');
        }
      } catch (e) {
        console.error('Failed to save search:', e);
      }
    });
  </script>
</body>
</html>
